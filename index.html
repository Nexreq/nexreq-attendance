<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nexreq Attendance</title>
    <!-- Include Tailwind via CDN for basic styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include React and ReactDOM from unpkg -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <!-- Include Babel for JSX transformation in the browser -->
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  </head>
  <body class="bg-gray-100 text-gray-900">
    <div class="container mx-auto p-4">
      <!-- Header with Nexreq logo and title -->
      <div class="flex items-center mb-4 space-x-2">
        <!-- Nexreq logo image. The SVG file is included alongside this index.html -->
        <img src="nexreq_logo.svg" alt="Nexreq Logo" class="h-10 w-auto" style="filter: invert(1);" />
        <h1 class="text-2xl font-bold">Nexreq Attendance</h1>
      </div>
      <div id="root"></div>
    </div>
    <script type="text/babel">
      const { useState, useEffect } = React;

      // Default list of employees. Khursheeda Parveen is working from home (WFH) by default.
      const DEFAULT_EMPLOYEES = [
        { id: 1, name: "Khursheeda Parveen", wfh: true },
        { id: 2, name: "Employee 2", wfh: false },
        { id: 3, name: "Employee 3", wfh: false },
        { id: 4, name: "Employee 4", wfh: false },
        { id: 5, name: "Employee 5", wfh: false },
        { id: 6, name: "Employee 6", wfh: false },
        { id: 7, name: "Employee 7", wfh: false },
        { id: 8, name: "Employee 8", wfh: false },
        { id: 9, name: "Employee 9", wfh: false },
        { id: 10, name: "Employee 10", wfh: false },
      ];

      function AttendanceApp() {
        // User/login state. We persist the current user to localStorage so the
        // page remembers who is logged in. Only users named "Rageeb" or
        // "Mujtaaba" are considered administrators. All others are normal
        // employees who can only clock in/out.
        const [user, setUser] = useState(() => {
          return localStorage.getItem("nexreq_user") || "";
        });
        const [isAdmin, setIsAdmin] = useState(() => {
          const stored = localStorage.getItem("nexreq_user");
          return stored === "Rageeb" || stored === "Mujtaaba";
        });
        const [loginName, setLoginName] = useState("");

        // Employees state: load from localStorage or use defaults
        const [employees, setEmployees] = useState(() => {
          const stored = localStorage.getItem("nexreq_employees");
          return stored ? JSON.parse(stored) : DEFAULT_EMPLOYEES;
        });

        // Account state: maps user names to an object with a passwordHash and admin flag.
        // If there are stored accounts in localStorage, load them; otherwise seed with two
        // default admin accounts. Passwords are stored as base64-encoded strings for
        // simplicity. In a production system you would never store plain passwords in
        // the browser.
        const [accounts, setAccounts] = useState(() => {
          const stored = localStorage.getItem("nexreq_accounts");
          if (stored) return JSON.parse(stored);
          return {
            Rageeb: { passwordHash: btoa("admin123"), isAdmin: true },
            Mujtaaba: { passwordHash: btoa("admin123"), isAdmin: true },
          };
        });

        // Signup/login form state
        const [signupName, setSignupName] = useState("");
        const [signupPassword, setSignupPassword] = useState("");
        const [loginPassword, setLoginPassword] = useState("");
        const [showSignup, setShowSignup] = useState(false);
        const [error, setError] = useState("");

        // Logs state: each log has {id, employeeId, startTime, endTime, location}
        const [logs, setLogs] = useState(() => {
          const stored = localStorage.getItem("nexreq_logs");
          return stored ? JSON.parse(stored) : [];
        });

        // Date range selection for summary
        const todayStr = new Date().toISOString().split("T")[0];
        const [fromDate, setFromDate] = useState(todayStr);
        const [toDate, setToDate] = useState(todayStr);

        // New employee input
        const [newName, setNewName] = useState("");
        const [newWFH, setNewWFH] = useState(false);

        // Persist employees and logs to localStorage
        useEffect(() => {
          localStorage.setItem("nexreq_employees", JSON.stringify(employees));
        }, [employees]);
        useEffect(() => {
          localStorage.setItem("nexreq_logs", JSON.stringify(logs));
        }, [logs]);

        // Persist accounts to localStorage whenever they change
        useEffect(() => {
          localStorage.setItem("nexreq_accounts", JSON.stringify(accounts));
        }, [accounts]);

        // Handle login and logout
        const handleLogin = () => {
          const name = loginName.trim();
          const pass = loginPassword;
          setError("");
          if (!name || !pass) {
            setError("Please enter your name and password.");
            return;
          }
          const acct = accounts[name];
          if (!acct || acct.passwordHash !== btoa(pass)) {
            setError("Invalid username or password.");
            return;
          }
          setUser(name);
          setIsAdmin(!!acct.isAdmin);
          localStorage.setItem("nexreq_user", name);
          // Clear password field
          setLoginPassword("");
          setLoginName("");
        };
        const handleLogout = () => {
          setUser("");
          setIsAdmin(false);
          localStorage.removeItem("nexreq_user");
        };

        // Handle signing up a new user. If the username already exists, show an error.
        // New users are created as non-admin. A corresponding employee entry is
        // automatically added. After successful signup the user is logged in.
        const handleSignup = () => {
          const name = signupName.trim();
          const pass = signupPassword;
          setError("");
          if (!name || !pass) {
            setError("Please enter a name and password to sign up.");
            return;
          }
          if (accounts[name]) {
            setError("User already exists. Please choose a different name or log in.");
            return;
          }
          // Determine next available employee ID
          const nextId = employees.length
            ? Math.max(...employees.map((e) => e.id)) + 1
            : 1;
          // Update accounts
          setAccounts({
            ...accounts,
            [name]: { passwordHash: btoa(pass), isAdmin: false },
          });
          // Add employee record
          setEmployees([...employees, { id: nextId, name: name, wfh: false }]);
          // Log in the new user
          setUser(name);
          setIsAdmin(false);
          localStorage.setItem("nexreq_user", name);
          // Clear form
          setSignupName("");
          setSignupPassword("");
        };

        // Utility: format date/time strings for display
        const formatDateTime = (iso) => {
          if (!iso) return "";
          const d = new Date(iso);
          return (
            d.toLocaleDateString(undefined, {
              year: "numeric",
              month: "short",
              day: "numeric",
            }) +
            " " +
            d.toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit" })
          );
        };

        // Add a new employee
        const addEmployee = () => {
          if (!newName.trim()) return;
          const nextId = employees.length ? Math.max(...employees.map((e) => e.id)) + 1 : 1;
          setEmployees([...employees, { id: nextId, name: newName.trim(), wfh: newWFH }]);
          setNewName("");
          setNewWFH(false);
        };

        // Toggle WFH setting for an employee (in admin mode)
        const toggleWFH = (id) => {
          setEmployees(
            employees.map((e) => (e.id === id ? { ...e, wfh: !e.wfh } : e))
          );
        };

        // Remove an employee (admin only). This will remove the employee from the list,
        // delete any associated logs, and remove their account if it exists. If the
        // removed employee is currently logged in, log them out.  Note that logs are
        // keyed by employeeId so removing the employee does not require updating
        // existing log records beyond filtering.
        const removeEmployee = (id) => {
          const emp = employees.find((e) => e.id === id);
          if (!emp) return;
          // Confirm with admin before removing
          if (!window.confirm(`Are you sure you want to remove ${emp.name}?`)) return;
          // Remove from employees array
          setEmployees(employees.filter((e) => e.id !== id));
          // Remove logs associated with this employee
          setLogs(logs.filter((log) => log.employeeId !== id));
          // Remove account associated with this name if present
          if (accounts[emp.name]) {
            const newAccounts = { ...accounts };
            delete newAccounts[emp.name];
            setAccounts(newAccounts);
            // If the removed employee is currently logged in, force logout
            if (user === emp.name) {
              setUser("");
              setIsAdmin(false);
              localStorage.removeItem("nexreq_user");
            }
          }
        };

        // Rename an employee (admin only). This prompts the admin for a new name,
        // updates the employees list and corresponding account key. If the current
        // logged in user is being renamed, update the user state accordingly.
        const renameEmployee = (id) => {
          const emp = employees.find((e) => e.id === id);
          if (!emp) return;
          const newName = window.prompt("Enter a new name for this employee", emp.name);
          if (!newName) return;
          const trimmed = newName.trim();
          if (!trimmed || trimmed === emp.name) return;
          // Update employees list
          setEmployees(
            employees.map((e) =>
              e.id === id
                ? { ...e, name: trimmed }
                : e
            )
          );
          // Update accounts: move account under new key if exists
          if (accounts[emp.name]) {
            const newAccounts = { ...accounts };
            newAccounts[trimmed] = newAccounts[emp.name];
            delete newAccounts[emp.name];
            setAccounts(newAccounts);
            // If the renamed employee is currently logged in, update user state
            if (user === emp.name) {
              setUser(trimmed);
              localStorage.setItem("nexreq_user", trimmed);
            }
          }
        };

        // Clock in function
        const clockIn = (employee) => {
          // Create new log entry
          const newLog = {
            id: logs.length ? Math.max(...logs.map((l) => l.id)) + 1 : 1,
            employeeId: employee.id,
            startTime: new Date().toISOString(),
            endTime: null,
            location: employee.wfh ? "WFH" : "Office",
          };
          setLogs([...logs, newLog]);
        };

        // Clock out function
        const clockOut = (employee) => {
          // Find the most recent log without endTime for this employee
          const lastIndex = logs
            .slice()
            .reverse()
            .findIndex((log) => log.employeeId === employee.id && !log.endTime);
          if (lastIndex < 0) return; // nothing to clock out
          const idx = logs.length - 1 - lastIndex;
          const updatedLogs = logs.map((log, i) =>
            i === idx ? { ...log, endTime: new Date().toISOString() } : log
          );
          setLogs(updatedLogs);
        };

        // Check if employee is currently clocked in
        const isClockedIn = (employeeId) => {
          return logs.some(
            (log) => log.employeeId === employeeId && log.endTime === null
          );
        };

        // Compute hours for logs in the selected date range
        const getEmployeeHours = (employeeId) => {
          const from = new Date(fromDate + "T00:00:00");
          const to = new Date(toDate + "T23:59:59");
          let total = 0;
          logs.forEach((log) => {
            if (log.employeeId !== employeeId || !log.endTime) return;
            const start = new Date(log.startTime);
            const end = new Date(log.endTime);
            if (end < from || start > to) return;
            // Clamp start and end within the range
            const s = start < from ? from : start;
            const e = end > to ? to : end;
            total += (e - s) / 3600000; // hours
          });
          return total;
        };

        // Quick ranges
        const setRangeThisWeek = () => {
          const now = new Date();
          const day = now.getDay(); // 0 Sunday
          const diff = now.getDate() - day + (day === 0 ? -6 : 1); // Monday as start
          const monday = new Date(now.setDate(diff));
          const sunday = new Date(monday);
          sunday.setDate(monday.getDate() + 6);
          setFromDate(monday.toISOString().split("T")[0]);
          setToDate(sunday.toISOString().split("T")[0]);
        };
        const setRangeThisMonth = () => {
          const now = new Date();
          const first = new Date(now.getFullYear(), now.getMonth(), 1);
          const last = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          setFromDate(first.toISOString().split("T")[0]);
          setToDate(last.toISOString().split("T")[0]);
        };
        const setRangeLastMonth = () => {
          const now = new Date();
          const first = new Date(now.getFullYear(), now.getMonth() - 1, 1);
          const last = new Date(now.getFullYear(), now.getMonth(), 0);
          setFromDate(first.toISOString().split("T")[0]);
          setToDate(last.toISOString().split("T")[0]);
        };

        // Export logs to CSV
        const exportCSV = () => {
          const lines = [
            "Employee,Start Time,End Time,Hours,Location",
          ];
          logs.forEach((log) => {
            if (!log.endTime) return; // skip open logs
            const emp = employees.find((e) => e.id === log.employeeId);
            const start = formatDateTime(log.startTime);
            const end = formatDateTime(log.endTime);
            const hours = ((new Date(log.endTime) - new Date(log.startTime)) / 3600000).toFixed(2);
            lines.push(
              `${emp ? emp.name : log.employeeId},${start},${end},${hours},${log.location}`
            );
          });
          const csvContent = lines.join("\n");
          const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = `nexreq_attendance_logs_${fromDate}_${toDate}.csv`;
          link.click();
          URL.revokeObjectURL(url);
        };

        // If no user is logged in, show a simple login form. Once logged in,
        // employees can clock in/out and admins will see additional controls.
        if (!user) {
          return (
            <div className="max-w-md mx-auto bg-white p-6 rounded shadow mt-10">
              <h2 className="text-xl font-semibold mb-4 text-center">
                {showSignup ? "Sign Up" : "Login"}
              </h2>
              {error && (
                <p className="mb-2 text-red-600 text-sm text-center">{error}</p>
              )}
              {showSignup ? (
                <div className="flex flex-col gap-2">
                  <input
                    className="border rounded px-2 py-1"
                    placeholder="Enter your name"
                    value={signupName}
                    onChange={(e) => setSignupName(e.target.value)}
                  />
                  <input
                    type="password"
                    className="border rounded px-2 py-1"
                    placeholder="Create a password"
                    value={signupPassword}
                    onChange={(e) => setSignupPassword(e.target.value)}
                  />
                  <button
                    className="px-4 py-2 bg-green-600 text-white rounded"
                    onClick={handleSignup}
                  >
                    Sign Up
                  </button>
                  <button
                    className="text-blue-600 text-sm underline mt-2"
                    onClick={() => {
                      setShowSignup(false);
                      setError("");
                    }}
                  >
                    Have an account? Log in
                  </button>
                </div>
              ) : (
                <div className="flex flex-col gap-2">
                  <input
                    className="border rounded px-2 py-1"
                    placeholder="Enter your name"
                    value={loginName}
                    onChange={(e) => setLoginName(e.target.value)}
                  />
                  <input
                    type="password"
                    className="border rounded px-2 py-1"
                    placeholder="Password"
                    value={loginPassword}
                    onChange={(e) => setLoginPassword(e.target.value)}
                  />
                    <button
                      className="px-4 py-2 bg-blue-500 text-white rounded"
                      onClick={handleLogin}
                    >
                      Login
                    </button>
                    <button
                      className="text-blue-600 text-sm underline mt-2"
                      onClick={() => {
                        setShowSignup(true);
                        setError("");
                      }}
                    >
                      Don't have an account? Sign up
                    </button>
                  {/*
                    Informational note for administrative accounts.  We keep this brief to avoid
                    disclosing any default credentials.  Rageeb and Mujtaaba have admin privileges by default.
                  */}
                  <p className="text-xs text-gray-600 mt-2 text-center">
                    Admin accounts are preset for <strong>Rageeb</strong> and <strong>Mujtaaba</strong>.
                  </p>
                </div>
              )}
            </div>
          );
        }

        return (
          <div className="space-y-8">
            {/* Logged in banner */}
            <div className="flex justify-between items-center bg-white shadow px-4 py-2 rounded">
              <div>
                <span className="font-medium">Logged in as:</span> {user}
                {isAdmin ? (
                  <span className="ml-2 text-sm text-green-600 font-semibold">(Admin)</span>
                ) : (
                  <span className="ml-2 text-sm text-gray-600">(Employee)</span>
                )}
              </div>
              <button
                className="px-3 py-1 bg-gray-200 rounded text-sm"
                onClick={handleLogout}
              >
                Logout
              </button>
            </div>

            {/* Employee list and clock actions */}
            <div>
              <h2 className="text-xl font-semibold mb-2">{isAdmin ? "Employees" : "My Attendance"}</h2>
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {(isAdmin ? employees : employees.filter((emp) => emp.name === user)).map((emp) => (
                  <div
                    key={emp.id}
                    className="border rounded-lg p-4 bg-white shadow"
                  >
                    <div className="flex justify-between items-center mb-2">
                      <span className="font-medium">{emp.name}</span>
                      <span className="text-xs px-2 py-1 rounded bg-indigo-100 text-indigo-700">
                        {emp.wfh ? "WFH" : "Office"}
                      </span>
                    </div>
                    <div className="flex flex-col space-y-2">
                      <div className="flex gap-2">
                        {isClockedIn(emp.id) ? (
                          <button
                            className="px-3 py-1 bg-red-500 text-white rounded"
                            onClick={() => clockOut(emp)}
                          >
                            Clock Out
                          </button>
                        ) : (
                          <button
                            className="px-3 py-1 bg-green-500 text-white rounded"
                            onClick={() => clockIn(emp)}
                          >
                            Clock In
                          </button>
                        )}
                        {/* Toggle WFH for editing (admin only) */}
                        {isAdmin && (
                          <button
                            className="px-2 py-1 border rounded text-xs"
                            onClick={() => toggleWFH(emp.id)}
                          >
                            Toggle WFH
                          </button>
                        )}
                      </div>
                      {/* Admin controls: rename and remove employee */}
                      {isAdmin && (
                        <div className="flex gap-2">
                          <button
                            className="px-2 py-1 border rounded text-xs"
                            onClick={() => renameEmployee(emp.id)}
                          >
                            Edit
                          </button>
                          <button
                            className="px-2 py-1 border rounded text-xs text-red-700"
                            onClick={() => removeEmployee(emp.id)}
                          >
                            Remove
                          </button>
                        </div>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* Add Employee (admin only) */}
            {isAdmin && (
              <div className="p-4 bg-white shadow rounded">
                <h2 className="text-lg font-semibold mb-2">Add Employee</h2>
                <div className="flex flex-col sm:flex-row gap-2">
                  <input
                    className="border rounded px-2 py-1 flex-grow"
                    placeholder="Employee name"
                    value={newName}
                    onChange={(e) => setNewName(e.target.value)}
                  />
                  <label className="flex items-center gap-1">
                    <input
                      type="checkbox"
                      checked={newWFH}
                      onChange={(e) => setNewWFH(e.target.checked)}
                    />
                    WFH
                  </label>
                  <button
                    className="px-4 py-2 bg-blue-500 text-white rounded"
                    onClick={addEmployee}
                  >
                    Add
                  </button>
                </div>
              </div>
            )}

            {/* Summary (admin only) */}
            {isAdmin && (
              <div className="p-4 bg-white shadow rounded">
                <h2 className="text-lg font-semibold mb-2">Summary / Payroll</h2>
                <div className="flex flex-wrap gap-2 mb-2 items-center">
                  <label>
                    From: 
                    <input
                      type="date"
                      className="border rounded px-2 py-1 ml-1"
                      value={fromDate}
                      onChange={(e) => setFromDate(e.target.value)}
                    />
                  </label>
                  <label>
                    To: 
                    <input
                      type="date"
                      className="border rounded px-2 py-1 ml-1"
                      value={toDate}
                      onChange={(e) => setToDate(e.target.value)}
                    />
                  </label>
                  <button
                    className="px-3 py-1 bg-gray-200 rounded"
                    onClick={setRangeThisWeek}
                  >
                    This Week
                  </button>
                  <button
                    className="px-3 py-1 bg-gray-200 rounded"
                    onClick={setRangeThisMonth}
                  >
                    This Month
                  </button>
                  <button
                    className="px-3 py-1 bg-gray-200 rounded"
                    onClick={setRangeLastMonth}
                  >
                    Last Month
                  </button>
                  <button
                    className="px-3 py-1 bg-green-600 text-white rounded ml-auto"
                    onClick={exportCSV}
                  >
                    Export CSV
                  </button>
                </div>
                <div className="overflow-x-auto">
                  <table className="min-w-full border">
                    <thead className="bg-gray-100">
                      <tr>
                        <th className="px-2 py-1 border">Employee</th>
                        <th className="px-2 py-1 border">Hours (in range)</th>
                      </tr>
                    </thead>
                    <tbody>
                      {employees.map((emp) => (
                        <tr key={emp.id} className="even:bg-gray-50">
                          <td className="px-2 py-1 border">{emp.name}</td>
                          <td className="px-2 py-1 border">
                            {getEmployeeHours(emp.id).toFixed(2)}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<AttendanceApp />);
    </script>
  </body>
</html>